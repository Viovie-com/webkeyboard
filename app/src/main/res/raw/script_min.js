"use strict";var MsgPackRequest=function(b,a){this.onSuccess=b||function(d,c){console.log(d.status)};this.onError=a||function(d,c){console.log(d.status)};this.xhr=new XMLHttpRequest();this.xhr.responseType="arraybuffer";this.xhr.onreadystatechange=(function(){if(this.xhr.readyState==4){if(this.xhr.status==0){try{this.onError(this.xhr,msgpack.decode(new Uint8Array(this.xhr.response)))}catch(c){this.onError(this.xhr,null)}}else{if(200<=this.xhr.status&&this.xhr.status<400){try{this.onSuccess(this.xhr,msgpack.decode(new Uint8Array(this.xhr.response)))}catch(c){this.onSuccess(this.xhr,null)}}}}}).bind(this)};MsgPackRequest.prototype.get=function(a){this.xhr.open("GET",a,true);this.xhr.send()};MsgPackRequest.prototype.post=function(b,c){var a=msgpack.encode(c);this.xhr.open("POST",b,true);this.xhr.setRequestHeader("Content-Type","application/x-msgpack");this.xhr.send(a)};var InputArea=function(a){this.area=a;this.is_compositing=false;this.area.addEventListener("compositionstart",(function(){this.is_compositing=true}).bind(this));this.area.addEventListener("compositionend",(function(){this.is_compositing=false}).bind(this))};InputArea.prototype.setColor=function(a){if(a=="disable"){this.area.style.backgroundColor="#f1e1cd"}if(a=="local"){this.area.style.backgroundColor="#FFFFFF"}if(a=="direct"){this.area.style.backgroundColor="#f1f1ed"}};InputArea.prototype.getText=function(){return this.area.innerText};InputArea.prototype.putText=function(a){this.area.innerText=a};InputArea.prototype.clearText=function(){this.area.innerText=""};InputArea.prototype.setKeyDownEvent=function(a){this.area.onkeydown=a};InputArea.prototype.setKeyUpEvent=function(a){this.area.onkeyup=a};InputArea.prototype.focusInput=function(){this.area.focus()};var WebKeyboard=function(a){this.area=new InputArea(a);window.onblur=(function(){this.area.focusInput()}).bind(this);window.onfocus=(function(){this.area.focusInput()}).bind(this);this.area.focusInput();this.setDirect()};WebKeyboard.prototype.send_key=function(e,d,f,c,a){var b=new MsgPackRequest();b.post("/key",{mode:e,code:d,shift:f,ctrl:c,alt:a})};WebKeyboard.prototype.up=function(a){if(!a){a=window.event}this.appendText();this.send_key("U",a.keyCode,a.shiftKey,a.ctrlKey,a.altKey)};WebKeyboard.prototype.down=function(a){if(!a){a=window.event}if(a.ctrlKey||a.altKey||a.keyCode==13||a.keyCode==9||(a.keyCode>=112&&a.keyCode<=123)){a.preventDefault()}if(a.keyCode==115){this.setDisable();this.getText();return false}this.send_key("D",a.keyCode,a.shiftKey,a.ctrlKey,a.altKey)};WebKeyboard.prototype.getText=function(){var a=new MsgPackRequest((function(c,b){this.area.putText(b);this.setLocal()}).bind(this),(function(){this.getText()}).bind(this));a.get("/text")};WebKeyboard.prototype.fillText=function(){var a=new MsgPackRequest((function(){this.area.clearText();this.setDirect()}).bind(this),(function(){this.fillText()}).bind(this));a.post("/fill",this.area.getText())};WebKeyboard.prototype.appendText=function(){if(this.area.is_compositing||this.area.getText()==""){return}var a=new MsgPackRequest();a.post("/append",this.area.getText());this.area.clearText()};WebKeyboard.prototype.setDisable=function(){this.area.setColor("disable");this.area.setKeyDownEvent(null);this.area.setKeyUpEvent(null)};WebKeyboard.prototype.setLocal=function(){this.area.setColor("local");this.area.setKeyUpEvent((function(){var a=window.event;if(a.keyCode==115){this.fillText();this.setDisable();return false}return true}).bind(this));this.area.setKeyDownEvent(null)};WebKeyboard.prototype.setDirect=function(){this.area.setColor("direct");this.area.setKeyDownEvent(this.down.bind(this));this.area.setKeyUpEvent(this.up.bind(this))};window.onload=function(){new WebKeyboard(document.body)};